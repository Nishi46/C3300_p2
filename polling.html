<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Polling Locations Choropleth Map</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://unpkg.com/topojson@3"></script>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f0f8ff;
            color: #333;
            margin: 0;
            padding: 0;
        }

        header {
            background-color: #002868;
            color: white;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        h1 {
            margin: 0;
            font-size: 2.2em;
        }

        h3 {
            color: #002868;
            text-align: center;
            margin-top: 0;
        }

        .container {
            display: flex;
            justify-content: center;
            padding: 40px;
        }

        #filter-container {
            max-width: 250px;
            padding: 20px;
            margin-right: 40px;
            background-color: #f5f5f5;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        #choropleth {
            flex: 1;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            border-radius: 5px;
        }

        .tooltip {
            position: absolute;
            background: white;
            border: 1px solid #ccc;
            padding: 5px;
            border-radius: 5px;
            pointer-events: none;
            opacity: 0;
            color: #333;
        }

        .tooltip-box {
            width: 120px;
            height: auto;
            background-color: #333;
            color: white;
            padding: 8px;
            border-radius: 5px;
        }

        .county {
            stroke: #333;
            stroke-width: 0.5;
        }

        #polling-thresholds {
            list-style-type: none;
            padding: 0;
            margin: 0;
            width: 100%;
        }

        #polling-thresholds li {
            cursor: pointer;
            padding: 10px 15px;
            border-radius: 25px;
            font-size: 16px;
            text-align: center;
            background-color: #e8e8e8;
            transition: background-color 0.3s;
        }

        #polling-thresholds li:hover {
            background-color: #d1d1d1;
        }

        #polling-thresholds li.selected {
            background-color: #4CAF50;
            color: white;
        }

        #clear-filters {
            padding: 10px 20px;
            background-color: #f44336;
            color: white;
            font-size: 16px;
            font-weight: bold;
            border-radius: 20px;
            text-align: center;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        #clear-filters:hover {
            background-color: #d32f2f;
        }
    </style>
</head>

<body>
    <header>
        <h1>Polling Locations Choropleth Map</h1>
    </header>

    <div class="container">
        <div id="filter-container">
            <h3>Filter by Polling Locations</h3>
            <ul id="polling-thresholds"></ul>
            <div id="clear-filters">Clear Filters</div>
        </div>

        <!-- Choropleth Map SVG -->
        <svg id="choropleth" height="600" width="960"></svg>
    </div>

    <div class="tooltip" id="tooltip"></div>

    <script>
        const width = 960, height = 600;
        const svg = d3.select("#choropleth").attr("width", width).attr("height", height);

        Promise.all([
            d3.json("data/counties-10m.json"),
            d3.csv("data/polling_places.csv")
        ]).then(([topoData, pollingData]) => {

            const counties = topojson.feature(topoData, topoData.objects.counties);
            const locationCounts = d3.rollup(pollingData, v => v.length, d => d.county_name);
            const countsArray = Array.from(locationCounts.values());
            const colors = ["#ffd27f", "#66c2a4", "#238bba", "#1d91c0", "#0c2c84"];
            const colorScale = d3.scaleQuantile().domain(countsArray).range(colors);

            const projection = d3.geoAlbersUsa().fitSize([width, height], counties);
            const path = d3.geoPath().projection(projection);
            const tooltip = d3.select("#tooltip");

            svg.selectAll("path")
                .data(counties.features)
                .enter().append("path")
                .attr("d", path)
                .attr("class", "county")
                .attr("fill", d => {
                    const count = locationCounts.get(d.properties.name) || 0;
                    return colorScale(count);
                })
                .on("mouseover", function (event, d) {
                    const countyName = d.properties.name;
                    const count = locationCounts.get(countyName) || 0;
                    tooltip.transition().duration(200).style("opacity", 1);
                    tooltip.html(`<div class="tooltip-box"><strong>${countyName}</strong><br>Polling Locations: ${count}</div>`)
                        .style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 28) + "px");
                    d3.select(this).attr("stroke", "black").attr("stroke-width", 2).attr("fill-opacity", 0.5);
                })
                .on("mouseout", function () {
                    tooltip.transition().duration(200).style("opacity", 0);
                    d3.select(this).attr("stroke", "#333").attr("stroke-width", 0.5).attr("fill-opacity", 1);
                });

            const thresholds = colorScale.quantiles();
            const ul = d3.select("#polling-thresholds");

            ul.selectAll("li")
                .data(thresholds)
                .enter()
                .append("li")
                .text(threshold => `Up to ${d3.format(",.0f")(threshold)} polling locations`)
                .style("color", (d, i) => colors[i])
                .on("click", function (event, threshold) {
                    d3.select(this).classed("selected", !d3.select(this).classed("selected"));
                    highlightCounties(getSelectedThresholds());
                });

            function highlightCounties(selectedThresholds) {
                svg.selectAll("path").attr("fill", d => {
                    const count = locationCounts.get(d.properties.name) || 0;
                    return selectedThresholds.some(range => count < range) ? colorScale(count) : "#f0f0f0";
                });
            }

            function getSelectedThresholds() {
                return d3.selectAll("#polling-thresholds .selected").data().map(item => parseFloat(item));
            }

            d3.select("#clear-filters").on("click", () => {
                d3.selectAll("#polling-thresholds li").classed("selected", false);
                svg.selectAll("path").attr("fill", d => colorScale(locationCounts.get(d.properties.name) || 0));
            });

            const zoom = d3.zoom().scaleExtent([1, 8]).translateExtent([[0, 0], [width, height]])
                .on("zoom", (event) => svg.selectAll("path").attr("transform", event.transform));

            svg.call(zoom);
        }).catch(error => console.error("Error loading data:", error));
    </script>
</body>

</html>