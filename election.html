<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Election Results Choropleth Map</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://unpkg.com/topojson@3"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f0f8ff;
            color: #333;
            margin: 0;
            padding: 0;
        }
        header {
            background-color: #002868;
            color: white;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        h1 {
            margin: 0;
            font-size: 2.2em;
        }
        .tab-container {
            display: flex;
            justify-content: center;
            background-color: #f1f1f1;
            margin-bottom: 20px;
        }
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            border: 2px solid #ccc;
            margin: 0 10px;
            border-radius: 5px;
            transition: background-color 0.3s;
        }
        .tab:hover {
            background-color: #ddd;
        }
        .active-tab {
            background-color: #4CAF50;
            color: white;
        }
        .container {
            display: flex;
            padding: 40px;
            justify-content: center;
        }
        #filter-container {
            max-width: 250px;
            padding: 20px;
            margin-right: 40px;
            background-color: #f5f5f5;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        #vote-thresholds {
            list-style-type: none;
            padding: 0;
            width: 100%;
        }
        #vote-thresholds li {
            cursor: pointer;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 18px;
            font-weight: bold;
            text-align: center;
            background-color: #e8e8e8;
            transition: background-color 0.3s;
            margin-bottom: 12px;
        }
        #vote-thresholds li:hover {
            background-color: #d1d1d1;
        }
        #vote-thresholds li.selected {
            background-color: #4CAF50;
            color: white;
        }
        #clear-filters {
            padding: 10px 20px;
            background-color: #f44336;
            color: white;
            font-size: 18px;
            font-weight: bold;
            border-radius: 20px;
            text-align: center;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        #clear-filters:hover {
            background-color: #d32f2f;
        }
        #choropleth {
            flex: 1;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            border-radius: 5px;
        }
        .tooltip {
            position: absolute;
            background: white;
            border: 1px solid #ccc;
            padding: 5px;
            border-radius: 5px;
            pointer-events: none;
            opacity: 0;
            color: #333;
        }
        .tooltip-box {
            width: 150px;
            background-color: black;
            color: white;
            padding: 8px;
            border-radius: 5px;
        }
        #county-select-1, #county-select-2 {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
            border: 1px solid #ccc;
        }
        #comparison-result {
            margin-top: 20px;
            padding: 10px;
            background-color: #e8e8e8;
            border-radius: 5px;
        }
        #comparison-container {
            margin-bottom: 20px;
        }
        #compare-button {
            width: 100%;
            padding: 10px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            margin-top: 10px;
        }
        #compare-button:hover {
            background-color: #45a049;
        }
        #comparison-map {
            display: flex;
            justify-content: space-between;
        }
        .county-map {
            width: 48%;
        }
    </style>
</head>
<body>
    <header>
        <h1>Election Results Choropleth Map</h1>
    </header>
    <div class="tab-container">
        <div class="tab active-tab" data-map="vote-difference">Vote Difference</div>
        <div class="tab" data-map="dem-vote">Democratic Votes</div>
        <div class="tab" data-map="rep-vote">Republican Votes</div>
    </div>
    <div class="container">
        <div id="filter-container">
            <div id="comparison-container">
                <h3 style="text-align: center;">Compare Counties</h3>
                <select id="state-select">
                    <option value="">Select a state</option>
                </select>
                <select id="county-select-1">
                    <option value="">Select first county</option>
                </select>
                <select id="county-select-2">
                    <option value="">Select second county</option>
                </select>
                <button id="compare-button">Compare</button>
                <div id="comparison-result"></div>
            </div>
            <h3 style="text-align: center;">Filter by Vote Difference</h3>
            <ul id="vote-thresholds"></ul>
            <div id="clear-filters">Clear Filters</div>
        </div>
        <div id="map-container">
            <svg id="choropleth" height="600" width="960"></svg>
        </div>
    </div>
    <div class="tooltip" id="tooltip"></div>
    <script>
        const width = 960, height = 600;
        const svg = d3.select("#choropleth").attr("width", width).attr("height", height);
        let currentMapType = "vote-difference";
        let selectedThreshold = null;
        let countyNames = new Map();
        let comparisonMode = false;

        let povertyData;

        Promise.all([
            d3.json("data/counties-10m.json"),
            d3.csv("data/2020_elections.csv"),
            d3.csv("data/Poverty.csv")
        ]).then(([topoData, electionData, povertyCSV])=> {
            const counties = topojson.feature(topoData, topoData.objects.counties);
            const voteDifferences = d3.rollup(electionData, v => +v[0].per_point_diff, d => d.county_fips);
            const demVotes = d3.rollup(electionData, v => +v[0].votes_dem, d => d.county_fips);
            const repVotes = d3.rollup(electionData, v => +v[0].votes_gop, d => d.county_fips);

            // Populate county names map and dropdowns
            electionData.forEach(d => {
                countyNames.set(d.county_fips, d.county_name);
            });

            const countyOptions = Array.from(countyNames.entries())
                .sort((a, b) => a[1].localeCompare(b[1]))
                .map(([fips, name]) => `<option value="${fips}">${name}</option>`)
                .join('');
            d3.select("#county-select-1").html('<option value="">Select first county</option>' + countyOptions);
            d3.select("#county-select-2").html('<option value="">Select second county</option>' + countyOptions);

            const colorScales = {
                "vote-difference": d3.scaleQuantile().domain(Array.from(voteDifferences.values())).range(["#ffdddd", "#ff9999", "#ff6666", "#ff3333", "#cc0000"]),
                "dem-majority": d3.scaleQuantile().domain(Array.from(demVotes.values())).range(["#d3e5ff", "#99ccff", "#6699cc", "#336699", "#003366"]),
                "rep-majority": d3.scaleQuantile().domain(Array.from(repVotes.values())).range(["#fee0d2", "#fcbba1", "#fc9272", "#fb6a4a", "#de2d26"]),
            };

            const projection = d3.geoAlbersUsa().fitSize([width, height], counties);
            const path = d3.geoPath().projection(projection);

            const tooltip = d3.select("#tooltip");

            function updateMap(type) {
                svg.selectAll("*").remove();
                
                if (comparisonMode) {
                    renderComparisonView();
                    return;
                }

                svg.selectAll("path")
                    .data(counties.features)
                    .join("path")
                    .attr("d", path)
                    .attr("class", "county")
                    .attr("fill", d => {
                        const countyFips = d.id;
                        const demVote = demVotes.get(countyFips) || 0;
                        const repVote = repVotes.get(countyFips) || 0;
                        if (type === "vote-difference") {
                            const diff = voteDifferences.get(countyFips) || 0;
                            return diff > 0 ? colorScales["rep-majority"](repVote) : colorScales["dem-majority"](demVote);
                        } else if (type === "dem-vote") {
                            return colorScales["dem-majority"](demVote);
                        } else if (type === "rep-vote") {
                            return colorScales["rep-majority"](repVote);
                        }
                    })
                    .attr("stroke", "#333")
                    .attr("stroke-width", 0.5)
                    .on("mouseover", function (event, d) {
                        const countyFips = d.id;
                        const diff = voteDifferences.get(countyFips) || 0;
                        const value = type === "vote-difference" ? diff : (type === "dem-vote" ? demVotes.get(countyFips) : repVotes.get(countyFips));
                        tooltip.transition().duration(200).style("opacity", 1);
                        tooltip.html(`<div class="tooltip-box"><strong>County ID: ${countyFips}</strong><br>${type.replace('-', ' ')}: ${value}</div>`)
                            .style("left", (event.pageX + 10) + "px")
                            .style("top", (event.pageY - 20) + "px");
                    })
                    .on("mouseout", function () {
                        tooltip.transition().duration(200).style("opacity", 0);
                    });
            }
            povertyData = povertyCSV;

            const states = Array.from(new Set(povertyData.map(d => d.State)))
            .sort((a, b) => a.localeCompare(b));
    
    d3.select("#state-select")
        .selectAll("option")
        .data(states)
        .enter()
        .append("option")
        .attr("value", d => d)
        .text(d => d);

    // Event listener for state selection
    d3.select("#state-select").on("change", updateCountyDropdowns);

    function updateCountyDropdowns() {
        const selectedState = d3.select("#state-select").property("value");
        const countiesInState = povertyData.filter(d => d.State === selectedState);

        const countyOptions = countiesInState.map(d => `<option value="${d.FIPS_Code}">${d.Area_name}</option>`).join('');

        d3.select("#county-select-1").html('<option value="">Select first county</option>' + countyOptions);
        d3.select("#county-select-2").html('<option value="">Select second county</option>' + countyOptions);
    }

            
            function renderComparisonView() {
                svg.selectAll("*").remove();
            
                const fips1 = d3.select("#county-select-1").property("value");
                const fips2 = d3.select("#county-select-2").property("value");
            
                const selectedFeatures = counties.features.filter(d => [fips1, fips2].includes(d.id));
            
                // Create a new projection for each county
                selectedFeatures.forEach((feature, index) => {
                    const countyProjection = d3.geoAlbersUsa()
                        .fitSize([width / 2 - 20, height - 100], feature);
                    const countyPath = d3.geoPath().projection(countyProjection);
            
                    const countyGroup = svg.append("g")
                        .attr("transform", `translate(${index * (width / 2 + 10)}, 0)`);
            
                    const countyData = electionData.find(d => d.county_fips === feature.id);
                    const povertyInfo = povertyData.find(d => d.FIPS_Code === feature.id);
                    // Draw county
                    countyGroup.append("path")
                        .datum(feature)
                        .attr("d", countyPath)
                        .attr("fill", () => {
                            const diff = voteDifferences.get(feature.id) || 0;
                            return diff > 0 ? colorScales["rep-majority"](repVotes.get(feature.id)) : colorScales["dem-majority"](demVotes.get(feature.id));
                        })
                        .attr("stroke", "#333")
                        .attr("stroke-width", 1);
                    // Add state name
                    countyGroup.append("text")
                        .attr("x", width / 4)
                        .attr("y", height - 80)
                        .attr("text-anchor", "middle")
                        .attr("font-size", "16px")
                        .attr("font-weight", "bold")
                        .text(`State: ${povertyInfo.State}`);

                    // Add county name
                    countyGroup.append("text")
                        .attr("x", width / 4)
                        .attr("y", height - 60)
                        .attr("text-anchor", "middle")
                        .attr("font-size", "16px")
                        .attr("font-weight", "bold")
                        .text(countyData.county_name);
            
                    // Add vote data
                    countyGroup.append("text")
                        .attr("x", width / 4)
                        .attr("y", height - 40)
                        .attr("text-anchor", "middle")
                        .text(`Dem: ${countyData.votes_dem}, Rep: ${countyData.votes_gop}`);
            
                    // Add percentage difference
                    countyGroup.append("text")
                        .attr("x", width / 4)
                        .attr("y", height - 20)
                        .attr("text-anchor", "middle")
                        .text(`(${countyData.per_point_diff > 0 ? 'R+' : 'D+'}${Math.abs(countyData.per_point_diff).toFixed(2)}%)`);

                    countyGroup.append("text")
                        .attr("x", width / 4)
                        .attr("y", height -5)
                        .attr("text-anchor", "middle")
                        .text(`Poverty Rate: ${povertyInfo.PCTPOVALL_2021}%`);
                });
            }

            d3.selectAll(".tab").on("click", function () {
                const newMapType = d3.select(this).attr("data-map");
                d3.selectAll(".tab").classed("active-tab", false);
                d3.select(this).classed("active-tab", true);
                currentMapType = newMapType;
                comparisonMode = false;
                updateMap(currentMapType);
            });

            function renderThresholds() {
                const thresholds = [0, 1, 2, 3, 4];
                const thresholdsList = d3.select("#vote-thresholds").selectAll("li")
                    .data(thresholds)
                    .join("li")
                    .text(d => `Threshold: ±${d}`)
                    .classed("selected", d => selectedThreshold === d)
                    .on("click", function (event, d) {
                        selectedThreshold = (selectedThreshold === d) ? null : d;
                        d3.selectAll("#vote-thresholds li").classed("selected", false);
                        d3.select(this).classed("selected", true);
                        updateMap(currentMapType);
                    });
            }

            d3.select("#compare-button").on("click", function() {
                comparisonMode = true;
                updateMap(currentMapType);
            });

            d3.select("#clear-filters").on("click", function() {
                comparisonMode = false;
                d3.select("#county-select-1").property("value", "");
                d3.select("#county-select-2").property("value", "");
                d3.select("#comparison-result").html("");
                updateMap(currentMapType);
            });

            renderThresholds();
            updateMap(currentMapType);
            const zoom = d3.zoom().scaleExtent([1, 8]).translateExtent([[0, 0], [width, height]])
                .on("zoom", (event) => svg.selectAll("path").attr("transform", event.transform));

            svg.call(zoom);
        });
    </script>
</body>
</html>