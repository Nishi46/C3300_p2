<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Election Results Choropleth Map</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://unpkg.com/topojson@3"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
        }

        .county {
            stroke: #333;
            stroke-width: 0.5;
        }

        .tooltip {
            position: absolute;
            background: white;
            border: 1px solid #ccc;
            padding: 5px;
            border-radius: 5px;
            pointer-events: none;
            opacity: 0;
        }

        .tooltip-box {
            width: 150px;
            height: auto;
            background-color: black;
            color: white;
            padding: 5px;
            border-radius: 5px;
        }

        #content-container {
            display: flex;
            padding: 40px;
        }

        #choropleth {
            flex: 1;
        }

        #filter-container {
            position: relative;
            max-width: 250px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            margin-right: 40px;
            padding: 10px;
        }

        #vote-thresholds {
            list-style-type: none;
            padding: 0;
            width: 100%;
        }

        #vote-thresholds li {
            cursor: pointer;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 18px;
            font-weight: bold;
            text-align: center;
            background-color: #f7f7f7;
            width: 100%;
            margin-bottom: 12px;
        }

        #vote-thresholds li.selected {
            background-color: #4CAF50;
            color: white;
        }

        #clear-filters {
            padding: 9px 20px;
            background-color: #f44336;
            color: white;
            font-size: 18px;
            font-weight: bold;
            border-radius: 20px;
            text-align: center;
            cursor: pointer;
            width: 100%;
        }

        .tab-container {
            display: flex;
            justify-content: center;
            background-color: #f1f1f1;
            margin-bottom: 20px;
        }

        .tab {
            padding: 10px 20px;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            border: 2px solid #ccc;
            margin: 0 10px;
            border-radius: 5px;
        }

        .tab:hover {
            background-color: #ddd;
        }

        .active-tab {
            background-color: #4CAF50;
            color: white;
        }
    </style>
</head>

<body>
    <h2 style="text-align: center;">Election Results Choropleth Map</h2>

    <!-- Tabs for map types -->
    <div class="tab-container">
        <div class="tab active-tab" data-map="vote-difference">Vote Difference</div>
        <div class="tab" data-map="dem-vote">Democratic Votes</div>
        <div class="tab" data-map="rep-vote">Republican Votes</div>
    </div>

    <!-- Filter Section -->
    <div id="content-container">
        <div id="filter-container">
            <h3 style="text-align: center;">Filter by Vote Difference</h3>
            <ul id="vote-thresholds"></ul>
            <div id="clear-filters">Clear Filters</div>
        </div>
        <svg id="choropleth" height="600" width="960"></svg>
    </div>

    <div class="tooltip" id="tooltip"></div>
    <script>
        const width = 960, height = 600;
        const svg = d3.select("#choropleth").attr("width", width).attr("height", height);
        let currentMapType = "vote-difference";
    
        // Load data
        Promise.all([
            d3.json("data/counties-10m.json"),
            d3.csv("data/2020_elections.csv")
        ]).then(([topoData, electionData]) => {
    
            const counties = topojson.feature(topoData, topoData.objects.counties);
            const voteDifferences = d3.rollup(electionData, v => +v[0].per_point_diff, d => d.county_fips);
            const demVotes = d3.rollup(electionData, v => +v[0].votes_dem, d => d.county_fips);
            const repVotes = d3.rollup(electionData, v => +v[0].votes_gop, d => d.county_fips);
    
            // Color Scales
            const colorScales = {
                "vote-difference": d3.scaleQuantile().domain(Array.from(voteDifferences.values())).range(["#ffdddd", "#ff9999", "#ff6666", "#ff3333", "#cc0000"]),
                "dem-majority": d3.scaleQuantile().domain(Array.from(demVotes.values())).range(["#d3e5ff", "#99ccff", "#6699cc", "#336699", "#003366"]),
                "rep-majority": d3.scaleQuantile().domain(Array.from(repVotes.values())).range(["#fee0d2", "#fcbba1", "#fc9272", "#fb6a4a", "#de2d26"]),
            };
    
            // Projection and Path for rendering map
            const projection = d3.geoAlbersUsa().fitSize([width, height], counties);
            const path = d3.geoPath().projection(projection);
    
            const tooltip = d3.select("#tooltip");
    
            // Update the map based on the selected map type
            function updateMap(type) {
                svg.selectAll("path").data(counties.features)
                    .join("path")
                    .attr("d", path)
                    .attr("class", "county")
                    .attr("fill", d => {
                        const countyFips = d.id;
                        const demVote = demVotes.get(countyFips) || 0;
                        const repVote = repVotes.get(countyFips) || 0;
                        if (type === "vote-difference") {
                            const diff = voteDifferences.get(countyFips) || 0;
                            return diff > 0 ? colorScales["rep-majority"](repVote) : colorScales["dem-majority"](demVote);
                        } else if (type === "dem-vote") {
                            return colorScales["dem-majority"](demVote);
                        } else if (type === "rep-vote") {
                            return colorScales["rep-majority"](repVote);
                        }
                    })
                    .on("mouseover", function (event, d) {
                        const countyFips = d.id;
                        const diff = voteDifferences.get(countyFips) || 0;
                        const value = type === "vote-difference" ? diff : (type === "dem-vote" ? demVotes.get(countyFips) : repVotes.get(countyFips));
                        tooltip.transition().duration(200).style("opacity", 1);
                        tooltip.html(`
                            <div class="tooltip-box">
                                <strong>County ID: ${countyFips}</strong><br>
                                ${type.replace('-', ' ')}: ${value}
                            </div>`)
                            .style("left", (event.pageX + 10) + "px")
                            .style("top", (event.pageY - 28) + "px");
    
                        d3.select(this)
                            .attr("stroke", "black")
                            .attr("stroke-width", 2);
                    })
                    .on("mouseout", function () {
                        tooltip.transition().duration(200).style("opacity", 0);
                        d3.select(this)
                            .attr("stroke", "#333")
                            .attr("stroke-width", 0.5);
                    });
            }
    
            // Initialize the map
            updateMap(currentMapType);
    
            // Update threshold filters based on current map type
            function updateThresholds(type) {
                const ul = d3.select("#vote-thresholds");
                ul.selectAll("li").remove(); // Clear previous thresholds
    
                // Determine thresholds based on the selected map type
                let thresholds;
                if (type === "vote-difference") {
                    thresholds = colorScales["vote-difference"].quantiles();
                } else if (type === "dem-vote") {
                    thresholds = colorScales["dem-majority"].quantiles();
                } else if (type === "rep-vote") {
                    thresholds = colorScales["rep-majority"].quantiles();
                }
    
                // Populate thresholds in the list with appropriate text
                ul.selectAll("li")
                    .data(thresholds)
                    .enter()
                    .append("li")
                    .text(threshold => {
                        const label = type === "vote-difference" ? "difference" :
                                      type === "dem-vote" ? "Democratic votes" :
                                      "Republican votes";
                        return `Up to ${(threshold)} ${label}`;
                    })
                    .on("click", function (event, threshold) {
                        d3.select(this).classed("selected", !d3.select(this).classed("selected"));
                        const selectedThresholds = getSelectedThresholds();
                        highlightCounties(selectedThresholds);
                    });
            }
    
            // Highlight counties based on selected thresholds
            function highlightCounties(selectedThresholds) {
                svg.selectAll("path")
                    .attr("fill", function (d) {
                        const countyFips = d.id;
                        const demVote = demVotes.get(countyFips) || 0;
                        const repVote = repVotes.get(countyFips) || 0;
                        const diff = voteDifferences.get(countyFips) || 0;
                        
                        // Determine majority party
                        const isDemMajority = demVote > repVote;
                        const isInThreshold = selectedThresholds.some(range => Math.abs(diff) <= range);
            
                        // Apply color based on majority party if within the selected threshold
                        if (isInThreshold) {
                            return isDemMajority ? colorScales["dem-majority"](demVote) : colorScales["rep-majority"](repVote);
                        } else {
                            return "#f0f0f0"; // Grey out counties that don't match
                        }
                    });
            }
    
            function getSelectedThresholds() {
                const selectedItems = d3.selectAll("#vote-thresholds .selected").data();
                return selectedItems.map(item => parseFloat(item));
            }
    
            // Clear filters button
            d3.select("#clear-filters").on("click", function () {
                d3.selectAll("#vote-thresholds li").classed("selected", false);  // Deselect all filters
                
                svg.selectAll("path")
                    .attr("fill", function (d) {
                        const countyFips = d.id;
                        const demVote = demVotes.get(countyFips) || 0;
                        const repVote = repVotes.get(countyFips) || 0;
                        const diff = voteDifferences.get(countyFips) || 0;
            
                        // Use original logic to color by vote-difference with dem-majority and rep-majority colors
                        return diff > 0 ? colorScales["rep-majority"](repVote) : colorScales["dem-majority"](demVote);
                    });
            });
    
            // Tab click event to update thresholds and map colors based on the selected type
            d3.selectAll(".tab").on("click", function () {
                const selectedMapType = d3.select(this).attr("data-map");
                if (selectedMapType !== currentMapType) {
                    currentMapType = selectedMapType;
                    d3.selectAll(".tab").classed("active-tab", false);
                    d3.select(this).classed("active-tab", true);
                    updateMap(currentMapType);
                    updateThresholds(currentMapType);  // Update thresholds based on the new map type
                }
            });
    
            // Initialize thresholds for the default map type
            updateThresholds(currentMapType);
        });
        
    </script>
    
</body>

</html>
